# Import required module for Azure Storage
Import-Module Az.Storage

# UNC path and credentials
$uncPath = "\\YourFileServer\YourShareName"
$uncUser = "YourUsername"
$uncPassword = "YourPassword" | ConvertTo-SecureString -AsPlainText -Force
$uncCredential = New-Object System.Management.Automation.PSCredential ($uncUser, $uncPassword)

# Azure Storage Account details
$resourceGroupName = "YourResourceGroupName"
$storageAccountName = "YourStorageAccountName"
$containerName = "YourContainerName"

# Function to recursively search for "triggers" directory
function Find-TriggersDirectory {
    param (
        [string]$path
    )
    
    $triggersDir = Get-ChildItem -Path $path -Directory -Recurse | Where-Object { $_.Name -eq "triggers" }
    return $triggersDir
}

# Function to move files and copy to Azure Storage
function Process-TriggerFiles {
    param (
        [string]$triggersPath,
        [string]$topTriggersPath
    )
    
    $txtFiles = Get-ChildItem -Path $triggersPath -Filter "*.txt"
    
    foreach ($file in $txtFiles) {
        # Move file to topTriggers directory
        $destinationPath = Join-Path -Path $topTriggersPath -ChildPath $file.Name
        Move-Item -Path $file.FullName -Destination $destinationPath -Force
        
        # Copy file to Azure Storage Account
        $ctx = (Get-AzStorageAccount -ResourceGroupName $resourceGroupName -Name $storageAccountName).Context
        Set-AzStorageBlobContent -File $destinationPath -Container $containerName -Blob $file.Name -Context $ctx -UseConnectedAccount
    }
}

# Connect to Azure (for storage account access)
Connect-AzAccount -UseDeviceAuthentication

# Map the UNC path to a drive letter
$driveLetter = "Z"
New-PSDrive -Name $driveLetter -PSProvider FileSystem -Root $uncPath -Credential $uncCredential -Persist

try {
    # Change to the mapped drive
    Set-Location "${driveLetter}:"

    # Find "triggers" directories
    $triggersDirs = Find-TriggersDirectory -path "."

    # Process each "triggers" directory
    foreach ($triggersDir in $triggersDirs) {
        $parentPath = Split-Path -Parent $triggersDir.FullName
        $topTriggersPath = Join-Path -Path $parentPath -ChildPath "topTriggers"
        
        # Create topTriggers directory if it doesn't exist
        if (-not (Test-Path $topTriggersPath)) {
            New-Item -Path $topTriggersPath -ItemType Directory
        }
        
        # Process trigger files
        Process-TriggerFiles -triggersPath $triggersDir.FullName -topTriggersPath $topTriggersPath
    }
}
finally {
    # Change back to a safe location
    Set-Location $env:USERPROFILE

    # Remove the mapped drive
    Remove-PSDrive -Name $driveLetter -Force

    # Disconnect from Azure
    Disconnect-AzAccount
